<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .active-nav { color: #10B981; border-bottom: 2px solid #10B981; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-sm w-full bg-white p-8 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Admin Login</h2>
            <form onsubmit="handleLogin(event)">
                <div class="space-y-4">
                    <input type="text" id="username" placeholder="Username" class="w-full border-gray-200 rounded-lg p-3 text-sm" required>
                    <input type="password" id="password" placeholder="Password" class="w-full border-gray-200 rounded-lg p-3 text-sm" required>
                </div>
                <button type="submit" class="mt-6 w-full bg-emerald-500 text-white font-bold py-3 rounded-lg hover:bg-emerald-600 transition-all">Login</button>
                <p id="login-error" class="text-red-500 text-sm mt-2 text-center"></p>
            </form>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="admin-panel" class="hidden">
        <header class="bg-white border-b px-4 sm:px-6 py-4 shadow-sm overflow-x-auto">
            <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
                <h1 class="text-xl sm:text-2xl font-bold text-gray-900 whitespace-nowrap">QuickOrder Admin</h1>
                <nav class="flex space-x-4 sm:space-x-8 text-xs sm:text-base whitespace-nowrap pb-2 sm:pb-0">
                    <button id="nav-users" onclick="showSection('users')" class="active-nav font-semibold pb-1">Users</button>
                    <button id="nav-vendors" onclick="showSection('vendors')" class="text-gray-500 hover:text-emerald-600 font-semibold pb-1">Vendors</button>
                    <button id="nav-items" onclick="showSection('items')" class="text-gray-500 hover:text-emerald-600 font-semibold pb-1">Items</button>
                    <button id="nav-transactions" onclick="showSection('transactions')" class="text-gray-500 hover:text-emerald-600 font-semibold pb-1">Transactions</button>
                </nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto w-full p-4 sm:p-6 lg:p-8">
            <!-- Sections -->
            <section id="users-section">
                <div class="bg-white rounded-xl shadow-sm overflow-x-auto">
                     <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Shop</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Contact</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Details</th></tr>
                        </thead>
                        <tbody id="users-list" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </section>

            <section id="vendors-section" class="hidden space-y-6">
                 <button onclick="openModal('vendor')" class="bg-emerald-500 text-white px-6 py-2 rounded-lg font-bold">Add Vendor</button>
                <div class="bg-white rounded-xl shadow-sm overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Vendor</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">WhatsApp</th><th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase">Actions</th></tr>
                        </thead>
                        <tbody id="vendors-list" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </section>

            <section id="items-section" class="hidden space-y-6">
                <div class="flex space-x-4 border-b">
                    <button id="tab-all-items" onclick="filterItems('all')" class="border-b-2 border-emerald-500 px-4 py-2 font-bold text-emerald-600">All Items</button>
                    <button id="tab-common-items" onclick="filterItems('common')" class="px-4 py-2 text-gray-500 hover:text-emerald-600 font-bold">Common Items</button>
                </div>
                <button onclick="openModal('item')" class="bg-emerald-500 text-white px-6 py-2 rounded-lg font-bold">Add Item</button>
                <div class="bg-white rounded-xl shadow-sm overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Item</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Vendor</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Price</th><th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase">Actions</th></tr>
                        </thead>
                        <tbody id="items-list" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </section>

            <section id="transactions-section" class="hidden space-y-6">
                <div class="flex gap-4 items-end bg-white p-4 rounded-xl shadow-sm">
                    <input type="date" id="start-date" class="border p-2 rounded text-sm">
                    <input type="date" id="end-date" class="border p-2 rounded text-sm">
                    <button onclick="applyDateFilter()" class="bg-emerald-500 text-white px-4 py-2 rounded font-bold text-sm">Filter</button>
                </div>
                <div id="vendor-stats" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
                <div class="bg-white rounded-xl shadow-sm overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Date</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Vendor</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Amount</th></tr>
                        </thead>
                        <tbody id="orders-list" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Add Item</h3>
            <form id="modal-form" onsubmit="handleFormSubmit(event)" class="space-y-4">
                <input type="hidden" id="form-type">
                <input type="hidden" id="edit-id">

                <div id="item-fields" class="space-y-4">
                    <label class="block text-sm font-bold">Select Vendors</label>
                    <div id="vendor-checkboxes" class="border rounded-lg p-2 space-y-1 max-h-32 overflow-y-auto"></div>
                    <input type="text" id="item-name" placeholder="Item Name" class="w-full border rounded-lg p-2" required>
                    <input type="number" step="0.01" id="item-price" placeholder="Price (₹)" class="w-full border rounded-lg p-2" required>
                    <select id="item-category" class="w-full border rounded-lg p-2">
                        <option>Vegetables</option><option>Dairy</option><option>Meat & Eggs</option><option>Staples</option><option>Spices & Herbs</option>
                    </select>
                    <select id="item-unit" class="w-full border rounded-lg p-2">
                        <option value="g">g</option><option value="kg">kg</option><option value="litre">L</option><option value="pieces">pcs</option>
                    </select>
                </div>

                <div id="vendor-fields" class="hidden space-y-4">
                    <input type="text" id="vendor-name" placeholder="Vendor Name" class="w-full border rounded-lg p-2">
                    <input type="text" id="vendor-phone" placeholder="WhatsApp (91...)" class="w-full border rounded-lg p-2">
                    <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="vendor-special"> <span>Special Vendor</span></label>
                </div>

                <div class="flex space-x-3">
                    <button type="button" onclick="closeModal()" class="flex-1 border py-2 rounded-lg">Cancel</button>
                    <button type="submit" class="flex-1 bg-emerald-500 text-white py-2 rounded-lg font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let vendors = []; let items = []; let orders = []; let currentItemFilter = 'all';

        async function loadData() {
            const [pRes, vRes, iRes, oRes] = await Promise.all([
                fetch('/api/all-profiles'), fetch('/api/vendors'), fetch('/api/items'), fetch('/api/orders')
            ]);
            const profiles = await pRes.json(); vendors = await vRes.json(); items = await iRes.json(); orders = await oRes.json();

            document.getElementById('users-list').innerHTML = profiles.map(p => `
                <tr><td class="px-4 py-3 font-bold">${p.shopName}<div class="text-xs font-normal">${p.ownerName}</div></td>
                <td class="px-4 py-3 text-sm">${p.phone}<div class="text-xs text-gray-500">${p.address}</div></td>
                <td class="px-4 py-3 text-xs uppercase font-bold">Role: ${p.role}</td></tr>`).join('');

            document.getElementById('vendors-list').innerHTML = vendors.map(v => `
                <tr><td class="px-4 py-3 font-bold">${v.name} ${v.isSpecial ? '⭐' : ''}</td><td class="px-4 py-3 text-sm">${v.phone}</td>
                <td class="px-4 py-3 text-right"><button onclick="editVendor('${v.id}')" class="text-blue-500 mr-2">Edit</button><button onclick="deleteVendor('${v.id}')" class="text-red-500">Delete</button></td></tr>`).join('');

            document.getElementById('vendor-checkboxes').innerHTML = `<label class="flex items-center space-x-2 text-xs"><input type="checkbox" value="common" class="vendor-check"> <span class="font-bold text-emerald-600">ALL VENDORS</span></label>` +
                vendors.map(v => `<label class="flex items-center space-x-2 text-xs"><input type="checkbox" value="${v.id}" class="vendor-check"> <span>${v.name}</span></label>`).join('');

            renderItems(); renderTransactions();
        }

        function renderItems() {
            const filtered = currentItemFilter === 'common' ? items.filter(i => i.vendorId === 'common') : items;
            document.getElementById('items-list').innerHTML = filtered.map(item => {
                const v = vendors.find(v => v.id === item.vendorId);
                return `<tr><td class="px-4 py-3 font-bold">${item.name}</td><td class="px-4 py-3 text-xs">${item.vendorId === 'common' ? 'COMMON' : (v ? v.name : '?')}</td>
                <td class="px-4 py-3 font-bold">₹${item.price}</td><td class="px-4 py-3 text-right"><button onclick="editItem('${item.id}')" class="text-blue-500 mr-2">Edit</button><button onclick="deleteItem('${item.id}')" class="text-red-500">Delete</button></td></tr>`;
            }).join('');
        }

        function renderTransactions() {
            document.getElementById('orders-list').innerHTML = orders.slice().reverse().map(o => {
                const v = vendors.find(v => v.id === o.vendorId);
                return `<tr><td class="px-4 py-3 text-xs">${new Date(o.createdAt).toLocaleDateString()}</td><td class="px-4 py-3 text-sm font-bold">${v ? v.name : '?'}</td><td class="px-4 py-3 font-bold">₹${o.totalAmount}</td></tr>`;
            }).join('');
        }

        function openModal(type, id = null) {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('form-type').value = type; document.getElementById('edit-id').value = id || '';
            document.getElementById('item-fields').classList.toggle('hidden', type !== 'item');
            document.getElementById('vendor-fields').classList.toggle('hidden', type !== 'vendor');
            if(id) {
                if(type==='item') {
                    const i = items.find(i=>i.id===id);
                    document.getElementById('item-name').value = i.name; document.getElementById('item-price').value = i.price;
                    document.getElementById('item-category').value = i.category; document.getElementById('item-unit').value = i.unit;
                    document.querySelectorAll('.vendor-check').forEach(c => c.checked = (c.value === i.vendorId));
                } else {
                    const v = vendors.find(v=>v.id===id);
                    document.getElementById('vendor-name').value = v.name; document.getElementById('vendor-phone').value = v.phone;
                    document.getElementById('vendor-special').checked = v.isSpecial;
                }
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const type = document.getElementById('form-type').value;
            const editId = document.getElementById('edit-id').value;
            const method = editId ? 'PATCH' : 'POST';
            const endpoint = (type === 'item' ? '/api/items' : '/api/vendors') + (editId ? `/${editId}` : '');

            let body = {};
            if(type === 'item') {
                const checks = document.querySelectorAll('.vendor-check:checked');
                const vendorIds = Array.from(checks).map(c => c.value);
                const data = {
                    name: document.getElementById('item-name').value,
                    price: document.getElementById('item-price').value,
                    category: document.getElementById('item-category').value,
                    unit: document.getElementById('item-unit').value
                };
                if(editId) { body = { ...data, vendorId: vendorIds[0] || 'common' }; }
                else { body = { ...data, vendorIds }; }
            } else {
                body = {
                    name: document.getElementById('vendor-name').value,
                    phone: document.getElementById('vendor-phone').value.replace(/\D/g, ''),
                    isSpecial: document.getElementById('vendor-special').checked
                };
            }

            const res = await fetch(endpoint, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if(res.ok) { closeModal(); loadData(); } else { alert('Error saving'); }
        }

        function handleLogin(e) { e.preventDefault(); if(document.getElementById('username').value==='admin' && document.getElementById('password').value==='password123') { sessionStorage.setItem('isAdminAuthenticated','true'); showAdminPanel(); } else { alert('Bad login'); } }
        function showAdminPanel() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('admin-panel').classList.remove('hidden'); loadData(); }
        if (sessionStorage.getItem('isAdminAuthenticated') === 'true') showAdminPanel();
        function showSection(s) { ['users', 'vendors', 'items', 'transactions'].forEach(id => { document.getElementById(`${id}-section`).classList.toggle('hidden', id !== s); document.getElementById(`nav-${id}`).classList.toggle('active-nav', id === s); }); }
        function closeModal() { document.getElementById('modal').style.display='none'; document.getElementById('modal-form').reset(); }
        function filterItems(f) { currentItemFilter = f; renderItems(); }
        function editVendor(id) { openModal('vendor', id); }
        function editItem(id) { openModal('item', id); }
        async function deleteVendor(id) { if(confirm('Delete?')) { await fetch(`/api/vendors/${id}`, { method: 'DELETE' }); loadData(); } }
        async function deleteItem(id) { if(confirm('Delete?')) { await fetch(`/api/items/${id}`, { method: 'DELETE' }); loadData(); } }
    </script>
</body>
</html>
